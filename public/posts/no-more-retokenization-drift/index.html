<!DOCTYPE html>
<html lang="en-us" dir="auto" data-theme="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=10701&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>No More Retokenization Drift | Agent Lightning ⚡ Blog</title>
<meta name="keywords" content="retokenization drift, agent rl, vllm, openai-compatible api, agent lightning">
<meta name="description" content="No More Retokenization Drift: Returning Token IDs via OpenAI Compatible APIs Matters in Agent RL
Agent Lightning (AGL) team
Date: Oct. 2025
TL;DR. Agent often calls LLMs via OpenAI‑compatible endpoints, which previously return only string-based inputs and outputs. In agent RL, this can lead to inconsistencies between training and inference due to the phenomenon we call Retokenization Drift. This phenomenon occurs because tokens are detokenized during inference and subsequently retokenized during training; the two sets of tokens may differ even though their corresponding strings are identical. Now, you can ask vLLM’s OpenAI‑compatible endpoints to return the exact token IDs for both prompts and generated responses. Pass &quot;return_token_ids&quot;: true to /v1/chat/completions or /v1/completions and you’ll receive prompt_token_ids and token_ids alongside the regular text output. This makes agent RL robust, as no more drift will happen. This pairs perfectly with Agent Lightning, where each model call is viewed as separate update sample without stitching; just log the returned IDs via return_token_ids enabled.">
<meta name="author" content="">
<link rel="canonical" href="http://localhost:10701/posts/no-more-retokenization-drift/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.fd5566c526ae48aadabd950798a2dc3568536401560eae5caac3765a42a9e7b5.css" integrity="sha256-/VVmxSauSKravZUHmKLcNWhTZAFWDq5cqsN2WkKp57U=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:10701/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:10701/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:10701/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:10701/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:10701/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en-us" href="http://localhost:10701/posts/no-more-retokenization-drift/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
                color-scheme: dark;
            }

            .list {
                background: var(--theme);
            }

            .toc {
                background: var(--entry);
            }
        }

        @media (prefers-color-scheme: light) {
            .list::-webkit-scrollbar-thumb {
                border-color: var(--code-bg);
            }
        }

    </style>
</noscript>
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.querySelector("html").dataset.theme = 'dark';
    } else if (localStorage.getItem("pref-theme") === "light") {
       document.querySelector("html").dataset.theme = 'light';
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.querySelector("html").dataset.theme = 'dark';
    } else {
        document.querySelector("html").dataset.theme = 'light';
    }

</script>
</head>
<body id="top">
    <header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:10701/" accesskey="h" title="Agent Lightning ⚡ Blog (Alt + H)">Agent Lightning ⚡ Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:10701/posts/" title="Posts">
                    <span>Posts</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:10701/about/" title="About">
                    <span>About</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:10701/">Home</a>&nbsp;»&nbsp;<a href="http://localhost:10701/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      No More Retokenization Drift
    </h1>
    <div class="post-meta"><span title='2025-11-18 01:13:13 +0800 CST'>November 18, 2025</span>&nbsp;·&nbsp;<span>8 min</span>

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#no-more-retokenization-drift-returning-token-ids-via-openai-compatible-apis-matters-in-agent-rl" aria-label="No More Retokenization Drift: Returning Token IDs via OpenAI Compatible APIs Matters in Agent RL">No More Retokenization Drift: Returning Token IDs via OpenAI Compatible APIs Matters in Agent RL</a><ul>
                        
                <li>
                    <a href="#why-token-ids-matter-for-agent-rl" aria-label="Why token IDs matter for Agent RL">Why token IDs matter for Agent RL</a></li>
                <li>
                    <a href="#solution-and-new-feature" aria-label="Solution and new feature">Solution and new feature</a></li>
                <li>
                    <a href="#introduction-to-agent-lightning-v02" aria-label="Introduction to Agent Lightning (v0.2)">Introduction to Agent Lightning (v0.2)</a><ul>
                        
                <li>
                    <a href="#the-middleware-for-agent-optimization" aria-label="The middleware for agent optimization">The middleware for agent optimization</a></li></ul>
                </li>
                <li>
                    <a href="#acknowledgements" aria-label="Acknowledgements">Acknowledgements</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="no-more-retokenization-drift-returning-token-ids-via-openai-compatible-apis-matters-in-agent-rl">No More Retokenization Drift: Returning Token IDs via OpenAI Compatible APIs Matters in Agent RL<a hidden class="anchor" aria-hidden="true" href="#no-more-retokenization-drift-returning-token-ids-via-openai-compatible-apis-matters-in-agent-rl">#</a></h1>
<p><em>Agent Lightning (AGL) team</em></p>
<p><em>Date: Oct. 2025</em></p>
<p><strong>TL;DR.</strong> Agent often calls LLMs via OpenAI‑compatible endpoints, which previously return only string-based inputs and outputs. In <strong>agent RL</strong>, this can lead to inconsistencies between training and inference due to the phenomenon we call <strong>Retokenization Drift</strong>. This phenomenon occurs because tokens are detokenized during inference and subsequently retokenized during training; the two sets of tokens may differ even though their corresponding strings are identical. Now, you can ask vLLM’s OpenAI‑compatible endpoints to return the <strong>exact token IDs</strong> for both prompts and generated responses. Pass <code>&quot;return_token_ids&quot;: true</code> to <code>/v1/chat/completions</code> or <code>/v1/completions</code> and you’ll receive <code>prompt_token_ids</code> and <code>token_ids</code> alongside the regular text output. This makes <strong>agent RL</strong> robust, as no more drift will happen. This pairs perfectly with Agent Lightning, where each model call is viewed as separate update sample without stitching; just log the returned IDs via <code>return_token_ids</code> enabled.</p>
<p>Links:</p>
<ul>
<li>Docs: <a href="https://docs.vllm.ai/en/v0.10.2/serving/openai_compatible_server.html#api-reference">OpenAI‑compatible server</a></li>
<li>Project to try with this feature: Agent Lightning (<a href="https://github.com/microsoft/agent-lightning">GitHub</a>, <a href="https://microsoft.github.io/agent-lightning/latest/">docs</a>)</li>
</ul>
<hr>
<h2 id="why-token-ids-matter-for-agent-rl">Why token IDs matter for Agent RL<a hidden class="anchor" aria-hidden="true" href="#why-token-ids-matter-for-agent-rl">#</a></h2>
<p>RL for LLMs trains on token sequences, so trainers need the exact token IDs sampled by the behavior policy. In single‑turn settings this used to be straightforward, since calling vLLM’s low‑level <code>generate</code> returns tokens directly.</p>
<p>In agent settings, most agent frameworks call OpenAI‑style <code>chat.completions</code> / <code>completions</code>. Agents prefer these APIs over raw <code>generate</code> because they provide the higher‑level affordances agent stacks are built around, such as <em>chat templating &amp; roles</em> (system/user/assistant), <em>tool/function calling</em>, structured outputs, and so on. These APIs historically return <strong>strings only</strong>, which might cause problems in agent RL. Previously, stored texts must be retokenized during training, but this is unstable and less accurate in practice, due to the <strong>retokenization drift</strong>.</p>
<blockquote>
<p>Symptoms you’ll see in RL: unstable learning curves, and hard‑to‑debug divergence between the data you think you optimized on vs. what the model actually sampled.
<img alt="image" loading="lazy" src="https://hackmd.io/_uploads/rJUpftz0xg.png">
<em>The red and blue lines are obtained with same settings (i.e., store texts and retokenization in training) and the yellow line directly use tokens from the inference engine.</em></p>
</blockquote>
<p>The drift may caused by the following three reasons.</p>
<ul>
<li><strong>Non-uniqueness of tokenization</strong>. In practice this shows up constantly: a word might be produced during generation as two tokens (e.g., <code>H</code> + <code>AVING</code>), but when you re‑tokenize the text later during training you get a different split (e.g., <code>HAV</code> + <code>ING</code>). The text looks identical, but the <em>IDs differ</em>, making your learner optimizes against the wrong sequence.
<img alt="image" loading="lazy" src="https://hackmd.io/_uploads/ByLAfYzCgx.png"></li>
<li><strong>Tool-call serialization</strong>. a generated tool call text like <code>&lt;tool_call&gt;{ &quot;name&quot;: ... }&lt;/tool_call&gt;</code> is parsed by tool call parser into an object that is required by chat completion API. Later, the object is rendered back to <code>&lt;tool_call&gt;{ &quot;name&quot;: ... }&lt;/tool_call&gt;</code> and retokenized again. Tool call parsing and re-rendering might cause changes in whitespace and formatting. In some situations, JSON errors may even be auto-corrected by the tool call parser. This masks the model’s true generation errors and preventing them from being trained away.</li>
<li><strong>Chat template difference</strong>. Chat template used in different frameworks could be slightly different. For example, one single LLaMA model can work with multiple chat templates (multiple in <a href="https://github.com/vllm-project/vllm/tree/1d165d6d859d3c50720f0c07209db2363c4fd33b/examples">vLLM</a> and one in <a href="https://huggingface.co/meta-llama">HuggingFace</a>). When different frameworks are used in inference and training, this divergence will produce different tokens.</li>
</ul>
<p>These three factors cause retokenization drift, and then lead to training instability, possibly because they result in the inconsistency between inference and training, and then cause <strong>off-policy RL updates</strong>. On-policy is a critical for stable RL training, and subtle changes can make big influences. The off-policy effect caused by retokenization drift is not even at the token level, and therefore cannot be corrected through token-level importance sampling.</p>
<p>The alternative is to save the token IDs generated by the model, as done in single-turn settings. This requires agents must communicate with the inference engine at the token level. However, most agents — especially those built with frameworks like LangChain — rely on OpenAI-compatible APIs and can’t tokenize or detokenize by themselves. See <a href="https://microsoft.github.io/agent-lightning/stable/deep-dive/serving-llm/#token-ids-and-why-they-matter">here</a> for more discussions about this part.</p>
<hr>
<h2 id="solution-and-new-feature">Solution and new feature<a hidden class="anchor" aria-hidden="true" href="#solution-and-new-feature">#</a></h2>
<p>A better solution is to use an <strong>OpenAI-compatible API that returns token IDs directly</strong>. The Agent Lightning and vLLM teams have collaborated to add this feature directly to <a href="https://github.com/vllm-project/vllm/pull/22587">vLLM core</a>. Starting with vLLM v0.10.2, the OpenAI-compatible API includes a <a href="https://docs.vllm.ai/en/v0.10.2/serving/openai_compatible_server.html#api-reference"><code>return_token_ids</code> parameter</a>, allowing token IDs to be requested alongside chat messages. When you set it to <code>true</code> on a request, the response includes two additional fields:</p>
<ul>
<li><code>prompt_token_ids</code>: the token IDs for the input (after any chat template processing), and</li>
<li><code>token_ids</code>: the token IDs generated for the completion, passed via <code>completion.choices</code>.</li>
</ul>
<p>Everything else in the response stays OpenAI‑compatible, so existing clients keep working.</p>
<hr>
<h2 id="introduction-to-agent-lightning-v02">Introduction to Agent Lightning (v0.2)<a hidden class="anchor" aria-hidden="true" href="#introduction-to-agent-lightning-v02">#</a></h2>
<p>In <a href="https://github.com/microsoft/agent-lightning">Agent Lightning</a> (AGL for short) initial version (v0.1), we delivers a flexible training framework for ANY agent with RL. It has several core features.</p>
<ul>
<li>Seamless integration with existing agents with ZERO CODE CHANGE (almost)!</li>
<li>Build with ANY agent framework (LangChain, OpenAI Agent SDK, Microsoft Agent Framework, &hellip;); or even WITHOUT agent framework (Python programs).</li>
<li>No constraints on the input to the LLM, allowing for flexible orchestration such as summarization, multi-agent collaboration, and other complex workflows.</li>
</ul>
<p>When Agent Lightning was first released, we implemented an <a href="https://github.com/microsoft/agent-lightning/blob/v0.1/agentlightning/instrumentation/vllm.py">instrumented vLLM server</a> that monkey-patched vLLM’s OpenAI server to return token IDs. Now, AGL automatically adds <code>return_token_ids</code> to each request so the engine includes token IDs in its response. Then, with the <a href="https://microsoft.github.io/agent-lightning/latest/tutorials/traces/">tracing</a> capability embedded in AGL, we automatically collect data required by the trainer side, including these token IDs.</p>
<h3 id="the-middleware-for-agent-optimization">The middleware for agent optimization<a hidden class="anchor" aria-hidden="true" href="#the-middleware-for-agent-optimization">#</a></h3>
<p>Starting from the perspective of more precise data collection, in v0.2 we have made AGL’s role in agent optimization more clear. Conceptually, Agent Lightning, or AGL, introduces a sustainable middleware layer and standardized data protocols for agent optimization, especially agent RL.</p>
<p><img alt="image" loading="lazy" src="https://hackmd.io/_uploads/HJA87tGRxx.png">
<em>Conceptual Overview of Agent Lightning</em></p>
<p>Agent Lightning is designed with a set of modular, interoperable components that together enable scalable and efficient agent RL. Each component plays a distinct role while communicating through standardized data protocols and well-defined interfaces.</p>
<ul>
<li><strong>Agent Runner</strong> — Responsible for executing agents to accomplish assigned tasks. It receives tasks, delegates them to agents for execution, collects both results and intermediate data, and reports these back to the data store. The Agent Runner operates separately with LLM side, thus can be hosted with different resources (e.g., CPUs) and can scale horizontally to support large numbers of concurrent agent instances.</li>
<li><strong>Algorithm (Model Trainer)</strong> — Hosts the large language models (LLMs) used for inference and training. This component orchestrates the overall RL loop, including <em>task sampling</em>, <em>rollout management</em>, and <em>model updates</em> based on collected experience data. It typically runs on GPU resources and interacts asynchronously with the Agent Runner through the shared data protocols.</li>
<li><a href="https://microsoft.github.io/agent-lightning/latest/how-to/write-first-algorithm/#the-central-hub-the-lightningstore"><strong>Data Store</strong></a> — Serves as the central repository for managing all data exchange and storage within the Agent RL ecosystem. It provides standardized interfaces and unified data schemas to ensure interoperability among heterogeneous components. Through this design, the Algorithm and Agent Runner can communicate <em>indirectly yet effectively</em>, enabling flexible and scalable collaboration. For instance, using the standardized <a href="https://microsoft.github.io/agent-lightning/latest/how-to/train-first-agent/#rollout"><code>rollouts</code></a>, the Algorithm can delegate tasks asynchronously to the Agent Runner, which executes them and reports execution traces back via the <a href="https://microsoft.github.io/agent-lightning/latest/how-to/train-first-agent/#span"><code>spans</code></a> data structure.</li>
</ul>
<p><img alt="image" loading="lazy" src="https://hackmd.io/_uploads/r1tDQYGCxe.png">
<em>The Training Loop in Agent Lightning</em></p>
<p>Under this data-store-centric design philosophy, all agent training iterations are abstracted into two steps. The first is to collect the agent-running data (spans in AGL) and store them in the data store; the second is to retrieve the required data from the store and send them to the algorithm side for training.</p>
<p>This abstracted view brings several advantages. First, it offers greater algorithmic flexibility: data collection can rely on <a href="https://microsoft.github.io/agent-lightning/latest/tutorials/traces/">various tracers</a> or <a href="https://microsoft.github.io/agent-lightning/latest/tutorials/write-agents/#emitting-rewards-messages-and-more">emit customized message</a>, making it straightforward to define different rewards or to capture any intermediate variables. On the algorithmic side, the required data can be accessed through <a href="https://microsoft.github.io/agent-lightning/latest/deep-dive/birds-eye-view/?h=query#putting-it-all-together-a-reinforcement-learning-example-verl">query</a> spans, and customized <a href="https://microsoft.github.io/agent-lightning/latest/deep-dive/birds-eye-view/#adapter">adapters</a> enable free data transformation.</p>
<p>This design also supports <a href="https://microsoft.github.io/agent-lightning/latest/algorithm-zoo/verl/#customization">algorithm customizations</a> like credit assignment, auxiliary model learning using partial data, training improvement through data adjustment, and so on. Moreover, within this framework, we can extend to more kind of algorithms, like <a href="https://microsoft.github.io/agent-lightning/latest/algorithm-zoo/apo/">automatic prompt tuning (APO)</a>, <a href="https://microsoft.github.io/agent-lightning/latest/how-to/unsloth-sft/">filtering high rewards data and fit them via Unsloth</a>.</p>
<p>The second major advantage of this design lies in its ability to reduce overall system complexity through modular separation, while enabling different components to utilize distinct resources and optimization strategies. An agent RL training system is inherently complex, as it leverages dynamic, environment-driven interactions to enable continual model learning from experiential data. A typical agent RL stack consists of several key components, including agent frameworks (e.g., LangChain, MCP), LLM inference engines (e.g., vLLM), and training frameworks (e.g., Megatron-LM). Without a decoupled architecture, the independence and heterogeneity of these components can lead to substantial system complexity. In contrast, a decoupled design allows the system to accommodate diverse resource requirements: for instance, the agent side may demand higher CPU capacity, whereas LLM inference and training are typically GPU-intensive. This modular structure also facilitates independent horizontal scaling for each component, improving both efficiency and maintainability.</p>
<p>More materials:</p>
<ul>
<li><a href="https://microsoft.github.io/agent-lightning/latest/">Full Documents</a></li>
<li><a href="https://microsoft.github.io/agent-lightning/latest/deep-dive/birds-eye-view/">Birds Eye View</a></li>
<li><a href="https://microsoft.github.io/agent-lightning/latest/how-to/train-sql-agent/">Train a SQL Agent (with multi-agent orchestration) using verl</a></li>
<li><a href="https://microsoft.github.io/agent-lightning/latest/how-to/train-first-agent/">Train a Room Selector Agent using Automatic Prompt Optimization</a>, where prompt orchestration is powered by <a href="https://github.com/microsoft/poml/">POML</a>.</li>
<li><a href="https://microsoft.github.io/agent-lightning/latest/how-to/unsloth-sft/">Train a Math Agent (build with OpenAI Agents SDK with MCP) using Unsloth</a></li>
</ul>
<p>Happy training! ⚡</p>
<h2 id="acknowledgements">Acknowledgements<a hidden class="anchor" aria-hidden="true" href="#acknowledgements">#</a></h2>
<p>We would like to express our sincere appreciation to vLLM maintainers, including <a href="https://github.com/youkaichao">Kaichao You</a>, <a href="https://github.com/njhill">Nick Hill</a>, <a href="https://github.com/aarnphm">Aaron Pham</a>, <a href="https://github.com/DarkLight1337">Cyrus Leung</a>, <a href="https://github.com/robertgshaw2-redhat">Robert Shaw</a> and <a href="https://github.com/simon-mo">Simon Mo</a>. Without their support and collaboration, this integration would not have been possible.</p>
<p>Agent Lightning is an open-source project from Microsoft Research. We sincerely appreciate the support from MSR for this open-source exploration. <a href="https://github.com/ultmaster">Yuge Zhang</a> is the primary contributor to this work.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:10701/tags/retokenization-drift/">Retokenization Drift</a></li>
      <li><a href="http://localhost:10701/tags/agent-rl/">Agent Rl</a></li>
      <li><a href="http://localhost:10701/tags/vllm/">Vllm</a></li>
      <li><a href="http://localhost:10701/tags/openai-compatible-api/">Openai-Compatible Api</a></li>
      <li><a href="http://localhost:10701/tags/agent-lightning/">Agent Lightning</a></li>
    </ul>
<nav class="paginav">
  <a class="next" href="http://localhost:10701/posts/hello-world/">
    <span class="title"> »</span>
    <br>
    <span>Hello World!</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share No More Retokenization Drift on x"
            href="https://x.com/intent/tweet/?text=No%20More%20Retokenization%20Drift&amp;url=http%3a%2f%2flocalhost%3a10701%2fposts%2fno-more-retokenization-drift%2f&amp;hashtags=retokenizationdrift%2cagentrl%2cvllm%2copenai-compatibleapi%2cagentlightning">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share No More Retokenization Drift on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http%3a%2f%2flocalhost%3a10701%2fposts%2fno-more-retokenization-drift%2f&amp;title=No%20More%20Retokenization%20Drift&amp;summary=No%20More%20Retokenization%20Drift&amp;source=http%3a%2f%2flocalhost%3a10701%2fposts%2fno-more-retokenization-drift%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share No More Retokenization Drift on reddit"
            href="https://reddit.com/submit?url=http%3a%2f%2flocalhost%3a10701%2fposts%2fno-more-retokenization-drift%2f&title=No%20More%20Retokenization%20Drift">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share No More Retokenization Drift on facebook"
            href="https://facebook.com/sharer/sharer.php?u=http%3a%2f%2flocalhost%3a10701%2fposts%2fno-more-retokenization-drift%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share No More Retokenization Drift on whatsapp"
            href="https://api.whatsapp.com/send?text=No%20More%20Retokenization%20Drift%20-%20http%3a%2f%2flocalhost%3a10701%2fposts%2fno-more-retokenization-drift%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share No More Retokenization Drift on telegram"
            href="https://telegram.me/share/url?text=No%20More%20Retokenization%20Drift&amp;url=http%3a%2f%2flocalhost%3a10701%2fposts%2fno-more-retokenization-drift%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share No More Retokenization Drift on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=No%20More%20Retokenization%20Drift&u=http%3a%2f%2flocalhost%3a10701%2fposts%2fno-more-retokenization-drift%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://localhost:10701/">Agent Lightning ⚡ Blog</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu');
    if (menu) {
        
        const scrollPosition = localStorage.getItem("menu-scroll-position");
        if (scrollPosition) {
            menu.scrollLeft = parseInt(scrollPosition, 10);
        }
        
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        const html = document.querySelector("html");
        if (html.dataset.theme === "dark") {
            html.dataset.theme = 'light';
            localStorage.setItem("pref-theme", 'light');
        } else {
            html.dataset.theme = 'dark';
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
